// from larreco/RecoAlg:
#include "hitalgorithms.fcl"
#include "HitFinderTools.fcl"

BEGIN_PROLOG

standard_hitcheater:
{
 module_type:       "HitCheater"
 G4ModuleLabel:     "largeant"
 WireModuleLabel:   "caldata"
 MinimumCharge:     5.
}

standard_hitcheater_preSpill:  @local::standard_hitcheater
standard_hitcheater_postSpill: @local::standard_hitcheater
standard_hitcheater_preSpill.WireModuleLabel:  "caldataPreSpill:preSpill"
standard_hitcheater_postSpill.WireModuleLabel: "caldataPostSpill:postSpill"

standard_hitfinder:
{
 module_type:         "FFTHitFinder"
 CalDataModuleLabel:  "caldata"      
 MinSigInd:            6.0              # Induction signal height threshold  
 MinSigCol:            11.0             # Collection signal height threshold
 IndWidth:             6.0              # Initial width for induction fit
 ColWidth:             7.8              # Initial width for collection fit
 IndMinWidth:          4.0              # Induction Hit width threshold
 ColMinWidth:          6.0              # Collection hit width threshold
 MaxMultiHit:          3                # maximum hits for multi fit   
 AreaMethod:           0                # 0 = area by integral, 1 = area by gaussian area formula
 AreaNorms:            [ 13.25, 26.31 ] # normalizations that put signal area in 
                                        # same scale as peak height. 
}

gaus_hitfinder:
{
 module_type:          "GausHitFinder"
 CalDataModuleLabel:   "caldata"
 MinSig:               [ 6.0, 11.0 ]      # signal height threshold, per plane
 MinWidth:             [ 4.0, 6.0 ]       # hit width threshold, per plane
 MaxMultiHit:          10                 # maximum hits for multi fit
 AreaMethod:           0                  # 0 = area by integral, 1 = area by gaussian area formula
 AreaNorms:            [ 13.25, 26.31 ]   # normalizations that put signal area in
                                          # same scale as peak height.
 LongMaxHits:          [  1,  1,  1]      # max number hits in long pulse trains
 LongPulseWidth:       [ 16, 16, 16]      # max widths for hits in long pulse trains
 TryNplus1Fits:        true		          # true will try to re-fit poorly modeled hits with n+1 gaussians
 					                      # false will NOT try to re-fit poorly modled hits
 Chi2NDF:              2000               # maximum Chisquared / NDF allowed for a hit to be saved (Set very high by default)

 AllHitsInstanceName:  ""                 # If non-null then this will be the instance name of all hits output to event
                                          # in this case there will be two hit collections, one filtered and one containing all hits
 FilterHits:           false              # true = do not keep undesired hits according to settings of HitFilterAlg object
 CandidateHits:        @local::candhitfinder_standard
 PeakFitter:           @local::peakfitter_gaussian
 HitFilterAlg:
 {
   AlgName: "HitFilterAlg"
   MinPulseHeight: [5.0, 5.0, 5.0]        #minimum hit peak amplitude per plane
   MinPulseSigma:  [1.0, 1.0, 1.0]        #minimum hit rms per plane
 }
                                          # In addition to the filter alg we can also filter hits on the same pulse train
 PulseHeightCuts:      [3.0,  3.0,  3.0 ] # Minimum pulse height
 PulseWidthCuts:       [2.0,  1.5,  1.0 ] # Minimum pulse width
 PulseRatioCuts:       [0.35, 0.40, 0.20] # Ratio of pulse height to width
}

dpraw_hitfinder:
{
 module_type:          		"DPRawHitFinder"
 LogLevel:	   		0

 CalDataModuleLabel:   		"caldata"
 MinSig:               		10    		# peak threshold for peak finding (in ADC). Peaks with lower amplitudes are neither fitted nor stored.
 TicksToStopPeakFinder: 	4		# when walking along waveform to find start and end points of a peak, stop when current tick is followed by minimum "TicksToStopPeakFinder" ticks 							# with equal or higher ADC counts (=inflection point). Stop anyway if ADC count of a tick is <= 0.

 MaxMultiHit:          		10              # maximum number of peaks in a group. Peaks in groups are fitted together. Fitting too many peaks together takes a lot of time!
						# When refitting, maximum number of peaks in group is: 1) not greater than 2xMaxMultiHit and 2) not greater than 3x number of peaks before re-fitting.
 GroupMaxDistance:		10		# maximum distance (in ticks) between two peaks to be grouped.
 GroupMinADC:			-5		# minimum ADC count between two peaks to be grouped.
 DoMergePeaks:			true		# true: enables peak merging for peaks in the same group.
 MergeADCSumThreshold:		0.2		# merge two peaks only if (ADC sum of the smaller peak) < MergeADCSumThreshold*(ADC sum of the bigger peak).
 MergeMaxADCThreshold:		0.2		# merge two peaks only if (height of the smaller peak) < MergeADCSumThreshold*(height of the bigger peak).

 MinWidth:             		10              # threshold for width (in ticks). Groups of peaks with smaller values are neither fitted nor stored.
 MinADCSum:    			10             	# threshold for ADC sum (in ADC*ticks). Groups of peaks with smaller values are neither fitted nor stored.
 MinADCSumOverWidth:    	2.4             # threshold for ADC sum over width (in ADC*ticks/ticks). Groups of peaks with smaller values are neither fitted nor stored.

 Chi2NDF:              		2000            # maximum chi square / NDF allowed for a fit to be stored as recob::Hit. Otherwise, calculate recob::Hit parameters from waveform.
 
 TryNplus1Fits:        		true		# true: will try to re-fit poorly modeled groups of peaks (chi2PerNDF>Chi2NDFRetry) while adding (an) additional peak(s).
 Chi2NDFRetry:         		25.0            # for single peaks: if the first fit returns a Chi2/NDF greater than this, try to re-fit.
 Chi2NDFRetryFactorMultiHits: 	2       	# for groups of peaks (2 or more): if the first fit returns a Chi2/NDF greater than Chi2NDFRetryFactorMultiHits*Chi2NDFRetry, try to re-fit.

 ChargeNorm:           		1		# Normalization for fit integral. Should be set to 1.
 NumBinsToAverage:     		0		# 0 or 1 = no averaging.
 MinTau:			0.01		# minimum value of the rising and falling time constants of the fit, in microseconds.
 MaxTau:			5		# maximum value of the rising and falling time constants of the fit, in microseconds.
 FitPeakMeanRange:		5		# range in that the fitter can move the mean of the fit function w.r.t. the peak.

 WidthNormalization:    	2.335		# standard width of the fitted hit is the FWHM of the fitted function (full width at half maximum). 
						# This width is divied by 'WidthNormalization' and saved to the recob::Hit.
						# standard value is chosen to be 2.335 = 2*sqrt(2*ln(2)), which is the relation between FWHM and standard deviation for the Gaussian distribution.

 FilterHits:           		false           # true = do not keep undesired hits according to settings of HitFilterAlg object
 HitFilterAlg:
 {
   AlgName: "HitFilterAlg"
   MinPulseHeight: [5.0, 5.0, 5.0]      #minimum hit peak amplitude per plane
   MinPulseSigma:  [1.0, 1.0, 1.0]      #minimum hit rms per plane
 }

}

standard_rffhitfinderalg:
{
    AmplitudeThreshold:   [ 0.0 ]
    MeanMatchThreshold:   [ 2.0 ]
    MinMergeMultiplicity: [ 2 ]
}

rff_hitfinder:
{
 module_type:           "RFFHitFinder"
 WireModuleLabel:       "caldata"
 RFFHitFinderAlgParams: @local::standard_rffhitfinderalg
}

tt_hitfinder:
{
 module_type:         "TTHitFinder"
 CalDataModuleLabel:  "caldata"
 MinSigPeakInd:       6.0
 MinSigPeakCol:       11.0
 MinSigTailInd:       2.0
 MinSigTailCol:       3.67
 IndWidth:            3
 ColWidth:            3
}

#For now, keep the APAHitFinder configured just like the GausHitFinder
apa_hitfinder:               @local::gaus_hitfinder
apa_hitfinder.module_type:   "APAHitFinder"


standard_hitfinderana:
{
 module_type:          "HitFinderAna"
 HitsModuleLabel:      "ffthit"
 LArGeantModuleLabel:  "largeant"
}

gaus_hitfinderana:
{
 module_type:          "GausHitFinderAna"
 HitsModuleLabel:      "gaushit"
 LArGeantModuleLabel:  "largeant"
}

standard_fasthitfinder:
{
 module_type:         "RawHitFinder"
 CalDataModuleLabel:  "caldata"      
 MinSigInd:            5.0              # Induction signal height threshold  
 MinSigCol:            5.0             # Collection signal height threshold
 IndWidth:             6.0              # Initial width for induction fit
 ColWidth:             7.8              # Initial width for collection fit
 IndMinWidth:          4.0              # Induction Hit width threshold
 ColMinWidth:          6.0              # Collection hit width threshold
 MaxMultiHit:          3                # maximum hits for multi fit   
 AreaMethod:           0                # 0 = area by integral, 1 = area by gaussian area formula
 AreaNorms:            [ 13.25, 26.31 ] # normalizations that put signal area in
}

standard_clustercrawlerhit:
{
 # call this: "cchit"
 module_type:         "HitFinder"
 CalDataModuleLabel:  "caldata"
 CCHitFinderAlg:      @local::standard_cchitfinderalg
} # standard_clustercrawlerhit


jp250L_hitfinder:       @local::standard_hitfinder
jp250L_gaushitfinder:   @local::gaus_hitfinder

bo_hitfinder:       @local::standard_hitfinder
bo_gaushitfinder:   @local::gaus_hitfinder

argoneut_hitfinder:     @local::standard_hitfinder
argoneut_gaushitfinder: @local::gaus_hitfinder
argoneut_mc_hitfinder:  @local::standard_hitfinder
argoneut_mc_hitfinder.AreaNorms: [ 12.89, 14.51 ]

microboone_hitfinder:     @local::standard_hitfinder
microboone_gaushitfinder: @local::gaus_hitfinder
microboone_rffhitfinder: @local::rff_hitfinder
microboone_hitfinder.IndMinWidth: 1.0
microboone_hitfinder.ColMinWidth: 1.0
microboone_gaushitfinder.MinSig: [ 6.0, 6.0, 11.0 ]
microboone_gaushitfinder.InitWidth: [ 6.0, 6.0, 7.8 ]
microboone_gaushitfinder.MinWidth:  [ 4.0, 4.0, 6.0 ]
microboone_gaushitfinder.AreaNorms: [ 13.25, 13.25, 26.31 ]
microboone_clustercrawlerhit: @local::standard_clustercrawlerhit
microboone_clustercrawlerhit.CCHitFinderAlg:      @local::microboone_cchitfinderalg
END_PROLOG
